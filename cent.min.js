/*!
 * Cent JavaScript template engine v0.2.0
 * https://github.com/baryshev/cent
 *
 * Copyright 2012, Vadim M. Baryshev <vadimbaryshev@gmail.com>
 * Licensed under the MIT license
 * https://github.com/baryshev/cent/LICENSE
 *
 * Includes parts of async
 * https://github.com/caolan/async
 * Copyright 2010 Caolan McMahon
 * Released under the MIT license
 *
 * Includes parts of node
 * https://github.com/joyent/node
 * Copyright Joyent, Inc. and other Node contributors
 * Released under the MIT license
 *
 * Includes Cross-Browser Split 1.0.1
 * http://xregexp.com/
 * Copyright Steven Levithan <stevenlevithan.com>
 * Released under the MIT license
 */
(function(){"use strict";var fs,path,CoffeeScript,async=function(){var e={},t=function(e,t){var n;if(e.forEach)return e.forEach(t);for(n=0;n<e.length;n++)t(e[n],n,e)},n=function(e,n){if(e.map)return e.map(n);var r=[];return t(e,function(e,t,i){r.push(n(e,t,i))}),r},r=function(e,t,r,i){var s=[];t=n(t,function(e,t){return{index:t,value:e}}),e(t,function(e,t){r(e.value,function(n,r){s[e.index]=r,t(n)})},function(e){i(e,s)})},i=function(t){return function(){var n=Array.prototype.slice.call(arguments);return t.apply(null,[e.forEach].concat(n))}};return e.forEach=function(e,n,r){if(!e.length)return r();var i=0;t(e,function(t){n(t,function(t){t?(r(t),r=function(){}):(i++,i===e.length&&r())})})},e.map=i(r),e.parallel=function(t,n){n=n||function(){},t.constructor===Array&&e.map(t,function(e,t){e&&e(function(e){var n=Array.prototype.slice.call(arguments,1);n.length<=1&&(n=n[0]),t.call(null,e,n)})},n)},e}(),Cent=function(options){if(!(this instanceof Cent))return new Cent(options);var cent=this;this.options={open:"<%",close:"%>",ext:"",useCache:!1,watchForChanges:!1,root:""};var trimExp=/^\s+|\s+$/g,escapeExp=/([.*+?\^=!:${}()|\[\]\/\\])/g,newlineExp=/\n/g,indentExp=/:$/,commandExp=/[^a-z]+/,quoteExp=/[\\']/g,crExp=/\r/g,cache={},loaders={},watchers={},indentChars={":":":",">":">"},regExpEscape=function(e){return String(e).replace(escapeExp,"\\$1")},parse=function(e){var t=1,n=["__centTemplate.buffer.push '"],r,i=e.split(new RegExp(regExpEscape(cent.options.open)+"((?:.|[\r\n])+?)(?:"+regExpEscape(cent.options.close)+"|$)")),s,o,u,a,f,l,c,h,p="",d=!1,v=[],m=-1;for(o=0,s=i.length;o<s;o++){u=i[o],a="";if(o%2===1){f="__centTemplate.line = "+t;switch(u.charAt(0)){case"=":l="', 0["+f+"], __centTemplate.escape(",c="), '",h="",u=u.substr(1);break;case"-":l="', 0["+f+"], (",c="), '",h="",u=u.substr(1);break;default:l="'\n"+f+"",c="\n__centTemplate.buffer.push '",h="\n"}u=u.replace(trimExp,""),a=u.split(commandExp)[0];if(r=indentChars[u.charAt(u.length-1)])u=u.replace(indentExp,"").replace(trimExp,""),r===":"&&(v.push(a),m++),a!=="block"&&(d=!0);switch(a){case"partial":l="', 0["+f+"], (",c="), '",n.push(l.replace(newlineExp,"\n"+p),u,c.replace(newlineExp,"\n"+p));break;case"content":l="', 0["+f+"], (",c="), '",u==="content"&&(c="()"+c),n.push(l.replace(newlineExp,"\n"+p),u,c.replace(newlineExp,"\n"+p));break;case"end":l="'";switch(v[m]){case"block":l="'\n__centTemplate.blockEnd(",c=")\n__centTemplate.buffer.push '",n.push(l.replace(newlineExp,"\n"+p)+c.replace(newlineExp,"\n"+p));break;case"when":c="\n__centTemplate.buffer.push ''",n.push(l.replace(newlineExp,"\n"+p)+c.replace(newlineExp,"\n"+p)),p=p.substr(2);break;case"switch":l="\n"+f+"",p=p.substr(2);default:v[m-1]==="switch"&&(c=""),p=p.substr(2),n.push(l.replace(newlineExp,"\n"+p)),n.push(c.replace(newlineExp,"\n"+p))}v.pop(),m--;break;case"else":v[m-1]==="switch"?l="":l="'",n.push(l.replace(newlineExp,"\n"+p)),v[m-1]==="if"&&(v.splice(-2,1),m--,p=p.substr(2)),n.push((h.length?h+p:"")+u),d&&(p+="  ",d=!1),n.push(c.replace(newlineExp,"\n"+p));break;case"switch":n.push(l.replace(newlineExp,"\n"+p),(h.length?h+p:"")+u),d&&(p+="  ",d=!1);break;case"when":n.push((h.length?h+p:"")+u),d&&(p+="  ",d=!1),n.push(c.replace(newlineExp,"\n"+p));break;default:n.push(l.replace(newlineExp,"\n"+p),(h.length?h+p:"")+u),d&&(p+="  ",d=!1),n.push(c.replace(newlineExp,"\n"+p))}}else v[m]!=="switch"&&n.push(u.replace(quoteExp,"\\$&").replace(crExp,"").replace(newlineExp,"\\n"));t+=u.split(newlineExp).length-1}return n.push("'\nreturn __centTemplate.buffer"),n=n.join(""),new Function("__centTemplate","partial","extend","block","content","return "+CoffeeScript.compile(n))},loaded=function(e,t,n){var r=loaders[t];delete loaders[t],async.forEach(r,function(t,r){t(e,n),r()},function(){})},read=function(file,callback){if(Object.prototype.toString.call(cent.options.root)==="[object Object]")try{var data=eval("(options.root."+file+")");Object.prototype.toString.call(data)==="[object String]"?callback(undefined,data):callback("Failed to load template")}catch(e){callback(e)}else fs.readFile(file,"utf8",callback)},load=function(e,t){cent.options.useCache&&cache[e]?t&&t(undefined,cache[e]):loaders[e]?t&&loaders[e].push(t):(loaders[e]=[],t&&loaders[e].push(t),read(e,function(t,n){if(t)loaded(t,e,undefined);else try{var r=parse(n);cent.options.useCache&&(cache[e]=r),loaded(undefined,e,r),cent.options.watchForChanges&&(watchers[e]=fs.watch(e,function(){watchers[e].close(),delete watchers[e],delete cache[e]}))}catch(i){i.message=i.message.replace(/ on line \d+/,"")+" in "+e,loaded(i,e,undefined)}}))},Template=function(e,t,n){this.file=e,Object.prototype.toString.call(cent.options.root)==="[object String]"&&(this.file=path.normalize((cent.options.root.length?cent.options.root+"/":"")+e+cent.options.ext)),this.data=t;if(n)for(var r in n)this.data[r]=n[r];this.buffer=[],this.tmpBuffer=undefined,this.watcher=undefined,this.line=1,this.partials=[],this.childData=[],this.childError=undefined,this.childCallback=undefined,this.callback=undefined,this.blocks={}};Template.prototype.blockStart=function(e){this.tmpBuffer=this.buffer,this.blocks[e]||(this.blocks[e]=[]),this.blocks[e].length?this.buffer=[]:this.buffer=this.blocks[e]},Template.prototype.blockEnd=function(){this.buffer=this.tmpBuffer,delete this.tmpBuffer},Template.prototype.partial=function(e,t){var n=[],r=new Template(e,this.data,t);return this.partials.push(function(e){r.render(function(t,r){t||n.push(r),e(t)})}),n},Template.prototype.extend=function(e,t){var n=new Template(e,this.data,t),r=this.callback;return n.blocks=this.blocks,this.callback=function(e,t){e?(n.childError=e,n.childCallback&&n.childCallback(e)):(n.childData.push(t),n.childCallback&&n.childCallback())},n.partials.push(function(e){n.childError?e(n.childError):n.childData.length?e():n.childCallback=e}),n.render(r),""},Template.prototype.content=function(e){return e&&e.length?(this.blocks[e]||(this.blocks[e]=[]),this.blocks[e]):this.childData},Template.prototype.render=function(e){var t=this;this.callback=e,load(this.file,function(e,n){if(e)t.callback&&t.callback(e,undefined);else try{var r=n.call(t.data,t,function(){return t.partial.apply(t,arguments)},function(){return t.extend.apply(t,arguments)},function(){return t.blockStart.apply(t,arguments)},function(){return t.content.apply(t,arguments)});async.parallel(t.partials,function(e){var n="",i,s;if(!e)for(s=0,i=r.length;s<i;s++){if(r[s]===undefined)continue;n+=Array.isArray(r[s])?r[s].join(""):r[s]}t.callback&&t.callback(e,n)})}catch(i){i.message=i.message+" in "+t.file+" on line "+t.line,t.callback&&t.callback(i,undefined)}})},Template.prototype.escape=function(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},this.configure=function(e){var t;e=e||{};for(t in e){if(typeof this.options[t]=="undefined")continue;this.options[t]=e[t]}},this.render=function(e,t,n){"function"==typeof t&&(n=t,t={});var r=new Template(e,t);r.render(n)},this.configure(options)};if(typeof module!="undefined"&&module.exports)fs=require("fs"),path=require("path"),CoffeeScript=require("coffee-script"),module.exports=Cent;else{Array.prototype.filter||(Array.prototype.filter=function(e,t){var n=this.length,r=[],i,s;if(typeof e!="function")throw new TypeError;for(i=0;i<n;i++)i in this&&(s=this[i],e.call(t,s,i,this)&&r.push(s));return r}),Array.prototype.forEach||(Array.prototype.forEach=function(e,t){var n=this.length,r;if(typeof e!="function")throw new TypeError;for(r=0;r<n;r++)r in this&&e.call(t,this[r],r,this)}),Array.isArray||(Array.isArray=function(e){return Object.prototype.toString.call(e)==="[object Array]"});var cbSplit;cbSplit||(cbSplit=function(e,t,n){if(Object.prototype.toString.call(t)!=="[object RegExp]")return cbSplit.nativeSplit.call(e,t,n);var r=[],i=0,s=(t.ignoreCase?"i":"")+(t.multiline?"m":"")+(t.sticky?"y":""),o,u,a,f;t=new RegExp(t.source,s+"g"),e+="",cbSplit.compliantExecNpcg||(o=new RegExp("^"+t.source+"$(?!\\s)",s));if(n===undefined||+n<0)n=Infinity;else{n=Math.floor(+n);if(!n)return[]}while(u=t.exec(e)){a=u.index+u[0].length;if(a>i){r.push(e.slice(i,u.index)),!cbSplit.compliantExecNpcg&&u.length>1&&u[0].replace(o,function(){var e;for(e=1;e<arguments.length-2;e++)arguments[e]===undefined&&(u[e]=undefined)}),u.length>1&&u.index<e.length&&Array.prototype.push.apply(r,u.slice(1)),f=u[0].length,i=a;if(r.length>=n)break}t.lastIndex===u.index&&t.lastIndex++}return i===e.length?(f||!t.test(""))&&r.push(""):r.push(e.slice(i)),r.length>n?r.slice(0,n):r},cbSplit.compliantExecNpcg=/()??/.exec("")[1]===undefined,cbSplit.nativeSplit=String.prototype.split),String.prototype.split=function(e,t){return cbSplit(this,e,t)},window.Cent=Cent,CoffeeScript=window.CoffeeScript,path=function(){var e=function(e,t){var n=0,r,i;for(r=e.length-1;r>=0;r--)i=e[r],i==="."?e.splice(r,1):i===".."?(e.splice(r,1),n++):n&&(e.splice(r,1),n--);if(t)while(n)e.unshift(".."),n--;return e},t=function(t){var n=t.charAt(0)==="/",r=t.slice(-1)==="/";return t=e(t.split("/").filter(function(e){return!!e}),!n).join("/"),!t&&!n&&(t="."),t&&r&&(t+="/"),(n?"/":"")+t};return{normalize:t}}();var AjaxObject=function(e,t){var n=this;this.updating=!1,this.abort=function(){n.updating&&(n.updating=!1,n.AJAX.abort(),n.AJAX=null)},this.update=function(){return n.updating?!1:(n.AJAX=null,window.XMLHttpRequest?(n.AJAX=new XMLHttpRequest,n.AJAX.overrideMimeType&&n.AJAX.overrideMimeType("text/html")):n.AJAX=new ActiveXObject("Microsoft.XMLHTTP"),n.AJAX===null?!1:(n.AJAX.onreadystatechange=function(){n.AJAX.readyState===4&&(n.updating=!1,n.callback(n.AJAX.responseText,n.AJAX.status,n.AJAX.responseXML),n.AJAX=null)},n.updating=new Date,n.AJAX.open("GET",e,!0),n.AJAX.send(null),!0))},this.callback=t||function(){}};fs=function(){var e=function(e,t,n){var r=new AjaxObject(e,function(e,t){t<200||t>399?n("Failed to load template"):n(undefined,e)});try{r.update()}catch(i){n(i)}},t=function(){};return{readFile:e,watch:t}}()}})();